<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blog | 邱张华</title>
  <link rel="icon" type="image/png" href="/images/q-96.png">
  <link rel="stylesheet" href="/css/site.css">
  <link rel="stylesheet" href="/css/prism-okaidia.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Roboto&display=fallback" rel="stylesheet">
</head>
<body>
<header>
  <a href="/" class="link--home">博客</a>
  <a href="/about" class="link--about">邱张华</a>
</header>
<main>
  <article>
  <h1>Kafka without Zookeeper with TDP</h1>
  <time datetime="2022-08-09T00:00:00.000Z">2022/08/09</time>
  <!-- Excerpt Start -->
<p>超越自我!</p>
<!-- Excerpt End -->
<h3>Environment</h3>
<ol>
<li>JDK 11 or 17 required</li>
<li>TDP installed</li>
</ol>
<h2>Steps</h2>
<ol>
<li>Package Kafka</li>
</ol>
<pre class="language-bash"><code class="language-bash">~/work/package-kafka.sh -v <span class="token number">3.2</span>.1 -o unix -w <span class="token string">"邱张华"</span></code></pre>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env sh</span><br><br><span class="token comment"># ~/work/package-kafka.sh -v 3.2.1 -o windows -w "邱张华"</span><br><span class="token comment"># ~/work/package-kafka.sh -v 3.2.1 -o unix -w "邱张华"</span><br><br><span class="token comment"># Usage under *nix</span><br><span class="token comment"># start-kafka3.sh</span><br><br><span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">"v:w:o:"</span> arg<br><span class="token keyword">do</span> <span class="token keyword">case</span> <span class="token variable">$arg</span> <span class="token keyword">in</span><br>  <span class="token function">v</span><span class="token punctuation">)</span><br>    <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OPTARG</span>"</span><br>    <span class="token punctuation">;</span><span class="token punctuation">;</span><br>  w<span class="token punctuation">)</span><br>    <span class="token assign-left variable">writer</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OPTARG</span>"</span><br>    <span class="token punctuation">;</span><span class="token punctuation">;</span><br>  o<span class="token punctuation">)</span><br>    <span class="token assign-left variable">os</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OPTARG</span>"</span><br>    <span class="token punctuation">;</span><span class="token punctuation">;</span><br>  ?<span class="token punctuation">)</span><br>    <span class="token builtin class-name">echo</span> <span class="token string">"unknown argument"</span><br>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><br>    <span class="token punctuation">;</span><span class="token punctuation">;</span><br>  <span class="token keyword">esac</span><br><span class="token keyword">done</span><br><br><br><span class="token builtin class-name">cd</span> ~/work<br><span class="token function">mkdir</span> -p ~/work/origin/kafka<br><span class="token builtin class-name">cd</span>  ~/work/origin/kafka<br><br><span class="token assign-left variable">zipFile</span><span class="token operator">=</span><span class="token string">"kafka_2.13-<span class="token variable">${version}</span>.tgz"</span><br><br><span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">${zipFile}</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> https://downloads.apache.org/kafka/<span class="token string">"<span class="token variable">${version}</span>"</span>/kafka_2.13-<span class="token string">"<span class="token variable">${version}</span>"</span>.tgz<br><span class="token function">rm</span> -rf ~/work/tmp<br><span class="token function">mkdir</span> -p ~/work/tmp<br><span class="token builtin class-name">cd</span> ~/work/tmp<br><br><span class="token function">tar</span> xvf ~/work/origin/kafka/<span class="token string">"<span class="token variable">${zipFile}</span>"</span><br><br><span class="token function">mv</span> kafka_2.13-<span class="token string">"<span class="token variable">${version}</span>"</span> kafka_<span class="token string">"<span class="token variable">${version}</span>"</span>_<span class="token string">"<span class="token variable">${os}</span>"</span><br><span class="token builtin class-name">cd</span> kafka_<span class="token string">"<span class="token variable">${version}</span>"</span>_<span class="token string">"<span class="token variable">${os}</span>"</span><br><br><br><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">${os}</span>"</span> <span class="token operator">=</span> <span class="token string">"windows"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">then</span><br><span class="token builtin class-name">echo</span> <span class="token string">""</span>"name: kafka<br>version: <span class="token variable">${version}</span><br>author: <span class="token variable">${writer}</span><br>env:<br>   KAFKA_HOME: <span class="token punctuation">\</span>"%PLUGIN_HOME%<span class="token punctuation">\</span>"<br>   <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> <span class="token punctuation">\</span>"%KAFKA_HOME%<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span>bin<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span>windows<span class="token punctuation">;</span>%<span class="token environment constant">PATH</span>%<span class="token punctuation">\</span>"<br><span class="token string">""</span>" <span class="token operator">></span>tdp_plugin.yaml<br><span class="token keyword">else</span><br><span class="token builtin class-name">echo</span> <span class="token string">""</span>"name: kafka<br>version: <span class="token variable">${version}</span><br>author: <span class="token variable">${writer}</span><br>env:<br>   KAFKA_HOME: <span class="token punctuation">\</span><span class="token variable">${PLUGIN_HOME}</span><br>   <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> <span class="token punctuation">\</span><span class="token variable">${KAFKA_HOME}</span>/bin:<span class="token punctuation">\</span><span class="token variable">${<span class="token environment constant">PATH</span>}</span><br><span class="token string">""</span>" <span class="token operator">></span> tdp_plugin.yaml<br><span class="token keyword">fi</span><br><br><br><span class="token builtin class-name">cd</span> ~/work/tmp<br><br><span class="token function">zip</span> -q kafka_<span class="token string">"<span class="token variable">${version}</span>"</span>_<span class="token string">"<span class="token variable">${os}</span>"</span>.zip -r -y kafka_<span class="token string">"<span class="token variable">${version}</span>"</span>_<span class="token string">"<span class="token variable">${os}</span>"</span>/<br><br><span class="token function">mkdir</span> -p ~/work/plugin<br><br><span class="token function">cp</span> kafka_<span class="token string">"<span class="token variable">${version}</span>"</span>_<span class="token string">"<span class="token variable">${os}</span>"</span>.zip ~/work/plugin</code></pre>
<ol start="2">
<li>Install Kafka</li>
</ol>
<pre class="language-bash"><code class="language-bash">tdp <span class="token function">install</span> plugin/kafka_3.2.1_unix.zip </code></pre>
<ol start="3">
<li>Create Kafka( Run ONLY once!!! or you'll lost your data!!)</li>
</ol>
<pre class="language-bash"><code class="language-bash">~/work/create-kafka3.sh</code></pre>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env sh</span><br><br><span class="token comment"># run create-kafka3.sh Only once!!!</span><br><br><span class="token assign-left variable">command</span><span class="token operator">=</span><span class="token string">"kafka-storage.sh random-uuid"</span><br><span class="token assign-left variable">uuid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>$command<span class="token variable">`</span></span><br><span class="token builtin class-name">echo</span> <span class="token variable">$uuid</span> <span class="token operator">></span> <span class="token variable">${TDP_HOME}</span>/data/kafka/uuid.txt<br><br><span class="token keyword">for</span> <span class="token for-or-select variable">number</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">6</span><span class="token punctuation">}</span><br><span class="token keyword">do</span><br>  <span class="token builtin class-name">printf</span> -v sn <span class="token string">"%02d"</span> <span class="token variable">$number</span><br>  <span class="token function">mkdir</span> -p <span class="token variable">${TDP_HOME}</span>/data/kafka/log<span class="token variable">$sn</span><br>  <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">9091</span><span class="token operator">+</span>$number<span class="token variable">))</span></span><br>  <span class="token builtin class-name">cd</span> <span class="token variable">${TDP_HOME}</span>/data/kafka<br>  <span class="token function">cp</span> <span class="token variable">$KAFKA_HOME</span>/config/kraft/server.properties server<span class="token variable">$sn</span>.properties<br>  <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">${TDP_HOME}</span>/data/kafka/log<span class="token variable">$sn</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>"</span><br>  <span class="token builtin class-name">printf</span> <span class="token string">"<br>node.id=<span class="token variable">$sn</span><br>listeners=PLAINTEXT://:<span class="token variable">$port</span>,CONTROLLER://:1<span class="token variable">$port</span><br>log.dirs=/Users/daniel/tdp/data/kafka/log<span class="token variable">$x</span><br>controller.quorum.voters=01@localhost:19092,02@localhost:19093,03@localhost:19094,04@localhost:19095,05@localhost:19096,06@localhost:19097<br>"</span> <span class="token operator">>></span> server<span class="token variable">$sn</span>.properties<br><br>kafka-storage.sh <span class="token function">format</span> -t <span class="token variable">$uuid</span> -c server<span class="token variable">$sn</span>.properties<br><span class="token keyword">done</span></code></pre>
<ol start="4">
<li>Start Kafka</li>
</ol>
<pre class="language-bash"><code class="language-bash">~/work/start-kafka3.sh</code></pre>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env sh</span><br><br><span class="token keyword">for</span> <span class="token for-or-select variable">number</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">6</span><span class="token punctuation">}</span><br><span class="token keyword">do</span><br>  <span class="token builtin class-name">printf</span> -v sn <span class="token string">"%02d"</span> <span class="token variable">$number</span><br>  <span class="token function">nohup</span> kafka-server-start.sh -daemon <span class="token variable">$TDP_HOME</span>/data/kafka/server<span class="token variable">${sn}</span>.properties<br><span class="token keyword">done</span><br><br><span class="token comment"># kafka-topics.sh --create --topic my-kafka-topic --bootstrap-server localhost:9092 --partitions 6 --replication-factor 2</span><br><span class="token comment"># kafka-topics.sh --list --bootstrap-server localhost:9092</span><br><span class="token comment"># kafka-topics.sh --describe --topic my-kafka-topic --bootstrap-server localhost:9092</span></code></pre>
<ol start="5">
<li>Stop Kafka</li>
</ol>
<pre class="language-bash"><code class="language-bash">kafka-server-stop.sh</code></pre>

</article>
</main>
<footer>&copy; qiuzhanghua.github.io 2022</footer>
</body>
</html>